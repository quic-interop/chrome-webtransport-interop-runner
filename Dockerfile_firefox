FROM martenseemann/quic-network-simulator-endpoint:latest AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Ubuntu 24+ only provides Firefox as snap; use Mozilla's .deb repo for Docker
RUN apt-get update && apt-get install -y wget
RUN install -d -m 0755 /etc/apt/keyrings && \
  wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O- | tee /etc/apt/keyrings/packages.mozilla.org.asc > /dev/null
RUN echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" > /etc/apt/sources.list.d/mozilla.list && \
  printf 'Package: *\nPin: origin packages.mozilla.org\nPin-Priority: 1000\n' > /etc/apt/preferences.d/mozilla

RUN apt-get update && \
  apt-get install -y python3 python3-pip wget xz-utils \
    libpci-dev libcanberra-gtk3-module libgles2-mesa-dev dbus-x11 \
    firefox && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/*

RUN pip3 install --break-system-packages selenium

ENV GECKODRIVER_VERSION="0.36.0"
RUN wget -q "https://github.com/mozilla/geckodriver/releases/download/v${GECKODRIVER_VERSION}/geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz" && \
  tar -xzf geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz -C /usr/bin && \
  chmod +x /usr/bin/geckodriver && \
  rm geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz

COPY script.js index.html run_firefox.py run.py run_endpoint_firefox.sh /

RUN mv /run_endpoint_firefox.sh /run_endpoint.sh && chmod +x /run_endpoint.sh

ENTRYPOINT [ "/run_endpoint.sh" ]
